!======================================! To calculate Velocity Autocorrelation Function via FFT! By Yanlei Wang@THU,Mar 2013! Reference: Goncalves S, Bonado H, Vibrational densities of states from molecular-dynamics calculations, Physical Review B, 1992, 46:12019!======================================program vacf_fft  use, intrinsic :: iso_c_binding  include 'fftw3.f03'    INTEGER :: nsteps,l,m,k,initstep,n  DOUBLE PRECISION, DIMENSION(:,:), ALLOCATABLE :: heat,heat_cent,z,mask,adj,acorr0,acorr,nor_acorr  DOUBLE PRECISION, DIMENSION(:,:,:),ALLOCATABLE :: pos,vel,acov  DOUBLE PRECISION, DIMENSION(:),ALLOCATABLE :: c,uc  DOUBLE COMPLEX,DIMENSION(:),ALLOCATABLE :: out  DOUBLE PRECISION :: mean,x,y,norm,time,tag  TYPE(C_PTR) :: plan_f,plan_inv,plan_m,datain1,datain2,dataout1,dataout2,datain_m,dataout_m ! REAL(C_DOUBLE),POINTER :: in_m(:)  COMPLEX(C_DOUBLE_COMPLEX),POINTER :: in1(:),out1(:),in2(:),in_m(:),out_m(:),out2(:)     !======================================! preparing read,and obtain nsteps&natoms!======================================  OPEN (11,FILE='input.data',STATUS='OLD') !in,velocity  OPEN (12,FILE='0vacf.data',STATUS='UNKNOWN') !out,vacf  OPEN (13,FILE='1nor_vacf.data',STATUS='UNKNOWN') 
  m=0  natoms = 1000 !Number of atoms  write(*,*) "please input the steps:" !number of frames in in.data  read(*,*) nsteps   !find the nextpow2   l = 2*nsteps-1  k=1  do while( k .LT. l)    k=2*k    m=m+1  end do  l=1  do i=1,m   l=2*l  end do write(*,*) l  !====================================== ! allocate data from dump file !======================================  ALLOCATE(c(nsteps),uc(nsteps),vel(nsteps,natoms,3),acov(nsteps,natoms,3))  allocate(nor_acorr(nsteps,3))  datain1=fftw_alloc_complex(INT(l,C_SIZE_T))  dataout1=fftw_alloc_complex(INT(l,C_SIZE_T))      CALL c_f_pointer(datain1,in1,[l])  CALL c_f_pointer(dataout1,out1,[l]) !====================================== ! read data from dump file 
 !======================================  REWIND(11)  do i = 1, nsteps    read(11,*)    read(11,*)    do j=1,natoms      read(11,*) tag,vel(i,j,:)    enddo end do!======================================! calculate Velocity Autocorrelation Function!======================================  do n =1,natoms  do j=1,3   do i=1,nsteps    in1(i) = vel(i,n,j) !The nth atom's vel at time i along direc. j   end do   do i=nsteps+1,l    in1(i) = 0   end do! forward FFT   plan_f= fftw_plan_dft_1d(l,in1,out1,-1,FFTW_ESTIMATE)  call fftw_execute_dft(plan_f,in1,out1)  do i=1,l    in1(i) = out1(i)  end do    do i=1,l    x=real(in1(i))    y=aimag(in1(i))    norm=x*x+y*y    in1(i) = norm  end do! Inversed FFT   plan_inv = fftw_plan_dft_1d(l,in1,out1,+1,FFTW_ESTIMATE)  call fftw_execute_dft(plan_inv,in1,out1)  do i=1,nsteps    acov(i,n,j) = real(out1(i))/l  end do end do end do! VACF do i = 1,nsteps  sumcorr = 0.d0  do j=1,3    do n=1,natoms     sumcorr = sumcorr+ acov(i,n,j)    end do  end do  c(i) = sumcorr end do uc(1) = c(1)/DBLE(nsteps) do i=2,nsteps   uc(i) = (c(i)/DBLE(nsteps+1-i))/uc(1) end do uc(1) =1.d0!======================================! export the VACF!======================================  write(12,*) "nsteps"  write(12,*) nsteps    do i=1,nsteps    write(12,'(I20,F30.10)') i,c(i)  end do  close(12)   do i=1,nsteps    write(13,'(I20,F20.10)') i,uc(i)  end do  close(13) end program vacf_fft